<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Comparativo - Implantações GenAI</title>

  <!-- Chart.js + Plugin de DataLabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

  <!-- XLSX (para ler planilhas Excel no navegador) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- Fonte / Ícones -->
  <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" as="style">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <style>
    html { scroll-behavior: smooth; }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    :root{
      /* Fundo */
      --background: #0c0e14;
      --card-bg: #1e2130;
      --card-bg-hover: #272936;
      --card-bg-secondary: #151823;

      /* Texto */
      --text: #ffffff;
      --muted: #a3a8c3;

      /* Destaques */
      --red-bradesco: #cc0000;
      --blue-bradesco: #0033A0;
      --purple-highlight: #7B68EE;
      --cyan-highlight: #00e5ff;

      /* Paleta por onda */
      --piloto: var(--cyan-highlight);
      --wave1: var(--purple-highlight);
      --wave2: var(--red-bradesco);
      --wave3: #ffa500;
      --wave4: #1dd1a1;

      /* UI */
      --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
      --shadow-hover: 0 20px 40px rgba(0, 0, 0, 0.4);
      --radius: 16px;
    }

    body {
      background: var(--background);
      color: var(--text);
      padding: 18px;
      background-image:
        radial-gradient(circle at 10% 20%, rgba(0, 51, 160, 0.15) 0%, rgba(0, 51, 160, 0) 70%),
        radial-gradient(circle at 90% 80%, rgba(204, 0, 0, 0.15) 0%, rgba(204, 0, 0, 0) 70%);
    }

    .container { max-width: 1280px; margin: 0 auto; }

    header {
      position: relative;
      display: flex; justify-content: center;
      margin-bottom: 18px; padding-bottom: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, .08);
    }

    header h1 {
      font-size: 28px; font-weight: 800; margin-bottom: 8px; text-align: center;
      background: linear-gradient(135deg, #0033A0, #7B68EE, #cc0000);
      -webkit-background-clip: text; background-clip: text; color: transparent;
    }

    header p { color: var(--muted); text-align: center; }

    /* Abas sob o título */
    .tabs { display:flex; gap:8px; justify-content:center; margin:-6px 0 14px; }
    .tab {
      display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border-radius:999px;
      background: linear-gradient(135deg, var(--blue-bradesco), var(--purple-highlight));
      color:#fff; font-weight:800; letter-spacing:.2px; text-decoration:none; box-shadow: var(--shadow);
      transition: transform .18s ease, box-shadow .18s ease, opacity .18s ease;
    }
    .tab:hover { transform: translateY(-1px); box-shadow: var(--shadow-hover); opacity:.95; }
    .tab i{ font-size:14px; }

    /* Botão Voltar */
    .back-button {
      position: fixed;
      top: 20px;
      left: 20px;
      background: linear-gradient(135deg, #0033A0, #7B68EE);
      color: #ffffff;
      border: none;
      border-radius: 50%;
      width: 50px; height: 50px;
      display: flex; align-items: center; justify-content: center;
      font-size: 20px; cursor: pointer; z-index: 1000;
      box-shadow: var(--shadow); transition: all 0.3s ease;
    }
    .back-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
      background: linear-gradient(135deg, #7B68EE, #0033A0);
    }

    /* KPIs */
    .kpis {
      display: grid; grid-template-columns: repeat(6, 1fr);
      gap: 10px; margin: 18px 0;
    }

    .kpi {
      position: relative; background: var(--card-bg); border-radius: var(--radius);
      padding: 14px 14px 12px; box-shadow: var(--shadow);
      border: 1px solid rgba(255, 255, 255, .06);
      transition: transform .18s ease, background .18s ease, border-color .18s ease;
      overflow: hidden; --accent: #6b7280; text-align: left;
    }
    .kpi:hover { transform: translateY(-2px); background: var(--card-bg-hover); border-color: rgba(255, 255, 255, .12); box-shadow: var(--shadow-hover); }
    .kpi-head { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .chip { width: 32px; height: 32px; border-radius: 999px; display: inline-flex; align-items: center; justify-content: center; background: rgba(255, 255, 255, .06); box-shadow: inset 0 0 0 1px rgba(255, 255, 255, .08); color: var(--accent); }
    .kpi h4 { font-size: 11px; letter-spacing: .3px; color: var(--muted); font-weight: 800; text-transform: uppercase; }
    .kpi .v { font-size: 26px; font-weight: 900; line-height: 1; margin: 4px 0 6px; }
    .kpi small { color: var(--muted); font-size: 12px; }
    .kpi strong { font-weight: 900; color: #fff; }

    .kpi--total { --accent: var(--blue-bradesco); }
    .kpi--ativos { --accent: #22c55e; }
    .kpi--sem { --accent: var(--red-bradesco); }
    .kpi--inter { --accent: var(--cyan-highlight); }
    .kpi--proj { --accent: var(--blue-bradesco); }
    .kpi--adocao { --accent: #22c55e; }

    /* Cabeçalhos das ondas */
    .implantation-headers { display: flex; gap: 10px; margin: 10px 0 12px; flex-wrap: wrap; }
    .implantation-header {
      flex: 1; background: var(--card-bg); border-radius: var(--radius);
      padding: 10px 12px; box-shadow: var(--shadow); border: 1px solid rgba(255, 255, 255, .06);
      transition: all 0.3s ease; min-width: 170px;
    }
    .implantation-header:hover { transform: translateY(-2px); box-shadow: var(--shadow-hover); background: var(--card-bg-hover); }
    .implantation-header h2 { font-size: 16px; margin-bottom: 4px; }
    .implantation-header p { font-size: 12px; color: var(--muted); margin: 0; }

    /* 5 colunas: Piloto | Wave 1 | Wave 2 | Wave 3 | Wave 4 */
    .grid { display: grid; grid-template-columns: repeat(5, minmax(0, 1fr)); gap: 10px; margin-bottom: 10px; }
    .grid-col { display: flex; flex-direction: column; gap: 10px; min-width: 0; }

    .card {
      background: var(--card-bg); border-radius: var(--radius); padding: 14px;
      box-shadow: var(--shadow); transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, .06);
    }
    .card:hover { transform: translateY(-2px); background: var(--card-bg-hover); border-color: rgba(255, 255, 255, .12); box-shadow: var(--shadow-hover); }

    .icon { font-size: 18px; margin-bottom: 8px; }
    .val { font-size: 22px; font-weight: 800; margin-bottom: 2px; }
    .lbl { font-size: 12px; color: var(--muted); }
    .sub { font-size: 11px; color: var(--muted); margin-top: 5px; }

    .tag { font-size: 11px; border-radius: 10px; padding: 2px 8px; display: inline-block; margin-top: 4px; font-weight: 700; }
    .tag.piloto { background: rgba(0, 229, 255, .18); color: var(--piloto); }
    .tag.wave1  { background: rgba(123, 104, 238, .18); color: var(--wave1); }
    .tag.wave2  { background: rgba(204,  0,   0, .18); color: var(--wave2); }
    .tag.wave3  { background: rgba(255, 165,   0, .18); color: var(--wave3); }
    .tag.wave4  { background: rgba( 29, 209, 161, .18); color: var(--wave4); }

    /* ======= Gráficos ======= */
    .chart-wrap{
      background: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow);
      padding: 12px 12px 8px; border: 1px solid rgba(255,255,255,.06);
      min-height: 0; height: 260px;
      position: relative; overflow: hidden;
      transition: box-shadow .18s ease, border-color .18s ease;
      margin-top: 10px;
    }
    .chart-wrap:hover{ box-shadow: var(--shadow-hover); border-color: rgba(255,255,255,.12); }

    .chart-title{
      font-weight: 800; margin: 6px 8px 0; line-height: 1.2;
      background: linear-gradient(135deg, #0033A0, #7B68EE);
      -webkit-background-clip: text; background-clip: text; color: transparent; display:inline-block;
    }

    .chart-wrap canvas{
      position: absolute; inset: 36px 8px 8px 8px;
      width: calc(100% - 16px) !important;
      height: calc(100% - 44px) !important;
      display: block;
    }

    /* UM gráfico por linha (sempre 1 coluna) */
    .charts-grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top:10px;
    }

    /* Perfis (cards de quantidade) */
    .profiles { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin: 12px 0 6px; }
    .profiles .kpi { text-align: center; }
    .profiles .kpi .kpi-head { justify-content: center; }
    .profiles .kpi .v { font-size: 24px; }

    @media (max-width: 1100px) {
      .kpis { grid-template-columns: repeat(3, 1fr); }
      .grid { grid-template-columns: repeat(2, 1fr); }
      .profiles { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 720px) {
      .kpis { grid-template-columns: repeat(2, 1fr); }
      .profiles { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 480px) {
      .kpis { grid-template-columns: 1fr; }
      .grid { grid-template-columns: 1fr; }
      .profiles { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div><h1>Adoção GEN AI Bradesco</h1></div>
    </header>

    <!-- Aba para a página de Taxa de Adoção (com ícone + nome) -->
    <nav class="tabs" role="tablist" aria-label="Navegação de seções do dashboard">
      <a class="tab" role="tab"
         href="https://marianacintra81.github.io/Bradesco-GEN-AI/Grafico_Taxa%20de%20Adocao.html">
        <i class="fas fa-gauge-high" aria-hidden="true"></i>
        <span>Taxa de Adoção</span>
      </a>
    </nav>

    <!-- Botão Voltar -->
    <a href="https://marianacintra81.github.io/Bradesco-GEN-AI/Menu%20Copilot%20e%20PromptX.html" class="back-button" aria-label="Voltar para a página anterior">
      <i class="fas fa-arrow-left" aria-hidden="true"></i>
    </a>

    <!-- KPIs (gerais) -->
    <section class="kpis" id="kpis">
      <div class="kpi kpi--total">
        <div class="kpi-head"><div class="chip"><i class="fas fa-users"></i></div><h4>Total de Profissionais</h4></div>
        <div class="v" id="k_total">—</div>
        <small>Treinados</small>
      </div>

      <div class="kpi kpi--ativos">
        <div class="kpi-head"><div class="chip"><i class="fas fa-user-check"></i></div><h4>Usuários ativos</h4></div>
        <div class="v" id="k_ativos">—</div>
        <small><strong id="k_adocao">—</strong> de adoção</small>
      </div>

      <div class="kpi kpi--sem">
        <div class="kpi-head"><div class="chip"><i class="fas fa-user-clock"></i></div><h4>Usuários sem interação</h4></div>
        <div class="v" id="k_sem">—</div>
        <small><strong id="k_sem_pct">—</strong> do total</small>
      </div>

      <div class="kpi kpi--inter">
        <div class="kpi-head"><div class="chip"><i class="fas fa-bolt"></i></div><h4>Total de Interações</h4></div>
        <div class="v" id="k_inter">13.464</div>
        <small id="k_media_global">Média: 43,4 por usuário ativo</small>
      </div>

      <div class="kpi kpi--proj">
        <div class="kpi-head"><div class="chip"><i class="fas fa-diagram-project"></i></div><h4>Projetos envolvidos</h4></div>
        <div class="v" id="k_proj_total">—</div>
        <small>Somatório de projetos mapeados</small>
      </div>

      <div class="kpi kpi--adocao">
        <div class="kpi-head"><div class="chip"><i class="fas fa-gauge-high"></i></div><h4>Taxa de Adoção (geral)</h4></div>
        <div class="v" id="k_taxa_v">—</div>
        <small id="k_taxa_desc">—</small>
      </div>
    </section>

    <!-- Distribuição por Perfil (cards) -->
    <section class="profiles" id="profilesGrid" aria-label="Distribuição por Perfil"></section>

    <!-- Cabeçalhos por Wave -->
    <div class="implantation-headers">
      <div class="implantation-header" style="border-top:4px solid var(--piloto);">
        <h2 style="color:var(--piloto)">Piloto</h2>
      </div>
      <div class="implantation-header" style="border-top:4px solid var(--wave1);">
        <h2 style="color:var(--wave1)">Wave 1</h2>
      </div>
      <div class="implantation-header" style="border-top:4px solid var(--wave2);">
        <h2 style="color:var(--wave2)">Wave 2</h2>
      </div>
      <div class="implantation-header" style="border-top:4px solid var(--wave3);">
        <h2 style="color:var(--wave3)">Wave 3</h2>
      </div>
      <div class="implantation-header" style="border-top:4px solid var(--wave4);">
        <h2 style="color:var(--wave4)">Wave 4</h2>
      </div>
    </div>

    <!-- Cards por Wave -->
    <section class="grid">
      <!-- Piloto -->
      <div class="grid-col">
        <div class="card">
          <div class="icon"><i class="fas fa-chart-pie" style="color:var(--piloto)"></i></div>
          <div class="val">100,0%</div><div class="lbl">Taxa de Adoção</div>
          <div class="sub"><span class="tag piloto">42 de 42 ativos</span></div>
        </div>
        <div class="card">
          <div class="icon"><i class="fas fa-sync-alt" style="color:var(--piloto)"></i></div>
          <div class="val" id="v_inter_piloto">3878</div><div class="lbl">Interações</div>
          <div class="sub"><strong>Média por total de usuários:</strong> <span id="avg_piloto">92,3</span></div>
        </div>
      </div>

      <!-- Wave 1 -->
      <div class="grid-col">
        <div class="card">
          <div class="icon"><i class="fas fa-chart-pie" style="color:var(--wave1)"></i></div>
          <div class="val">90,9%</div><div class="lbl">Taxa de Adoção</div>
          <div class="sub"><span class="tag wave1">20 de 22 ativos</span></div>
        </div>
        <div class="card">
          <div class="icon"><i class="fas fa-sync-alt" style="color:var(--wave1)"></i></div>
          <div class="val" id="v_inter_w1">992</div><div class="lbl">Interações</div>
          <div class="sub"><strong>Média por total de usuários:</strong> <span id="avg_w1">45,1</span></div>
        </div>
      </div>

      <!-- Wave 2 -->
      <div class="grid-col">
        <div class="card">
          <div class="icon"><i class="fas fa-chart-pie" style="color:var(--wave2)"></i></div>
          <div class="val">100,0%</div><div class="lbl">Taxa de Adoção</div>
          <div class="sub"><span class="tag wave2">69 de 69 ativos</span></div>
        </div>
        <div class="card">
          <div class="icon"><i class="fas fa-sync-alt" style="color:var(--wave2)"></i></div>
          <div class="val" id="v_inter_w2">4182</div><div class="lbl">Interações</div>
          <div class="sub"><strong>Média por total de usuários:</strong> <span id="avg_w2">60,6</span></div>
        </div>
      </div>

      <!-- Wave 3 -->
      <div class="grid-col">
        <div class="card">
          <div class="icon"><i class="fas fa-chart-pie" style="color:var(--wave3)"></i></div>
          <div class="val">93,9%</div><div class="lbl">Taxa de Adoção</div>
          <div class="sub"><span class="tag wave3">108 de 115 ativos</span></div>
        </div>
        <div class="card">
          <div class="icon"><i class="fas fa-sync-alt" style="color:var(--wave3)"></i></div>
          <div class="val" id="v_inter_w3">3374</div><div class="lbl">Interações</div>
          <div class="sub"><strong>Média por total de usuários:</strong> <span id="avg_w3">29,3</span></div>
        </div>
      </div>

      <!-- Wave 4 -->
      <div class="grid-col">
        <div class="card">
          <div class="icon"><i class="fas fa-chart-pie" style="color:var(--wave4)"></i></div>
          <div class="val" id="pct_w4">68,9%</div><div class="lbl">Taxa de Adoção</div>
          <div class="sub"><span class="tag wave4" id="tag_w4">71 de 103 ativos</span></div>
        </div>
        <div class="card">
          <div class="icon"><i class="fas fa-sync-alt" style="color:var(--wave4)"></i></div>
          <div class="val" id="v_inter_w4">1038</div><div class="lbl">Interações</div>
          <div class="sub"><strong>Média por total de usuários:</strong> <span id="avg_w4">10,1</span></div>
        </div>
      </div>
    </section>

    <!-- Grade de gráficos (1 gráfico por linha) -->
    <div class="charts-grid">
      <section class="chart-wrap">
        <div class="chart-title">Interações por Mês</div>
        <canvas id="interactionsByMonth"></canvas>
      </section>

      <section class="chart-wrap">
        <div class="chart-title">Interações por Perfil</div>
        <canvas id="interactionsByProfile"></canvas>
      </section>
    </div>
  </div>

  <!-- Input oculto para upload de planilha (Ctrl+U) -->
  <input type="file" id="hiddenSheetInput" accept=".xlsx,.xls,.csv" style="display:none" />

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // ===== Config global Chart.js para estabilidade =====
      Chart.register(ChartDataLabels);
      Chart.defaults.color = '#ffffff';
      Chart.defaults.font.family = 'Inter, sans-serif';
      Chart.defaults.responsive = true;
      Chart.defaults.maintainAspectRatio = false;
      Chart.defaults.animation = { duration: 0 };

      // --- KPIs iniciais (valores da planilha consolidada) ---
      const totals = {
        projetos: 49,
        profissionais: 351,
        ativos: 310,
        semInteracao: 41,
        totalInteracoes: 13464
      };
      const adocaoPct = (totals.ativos / totals.profissionais) * 100;
      const mediaGlobal = totals.ativos ? (totals.totalInteracoes / totals.ativos) : 0;

      // Preenche KPIs (estado inicial)
      document.getElementById('k_proj_total').textContent = totals.projetos;
      document.getElementById('k_total').textContent = totals.profissionais;
      document.getElementById('k_ativos').textContent = totals.ativos;
      document.getElementById('k_adocao').textContent =
        adocaoPct.toLocaleString('pt-BR', { maximumFractionDigits: 2 }) + '%';
      document.getElementById('k_sem').textContent = totals.semInteracao;
      document.getElementById('k_sem_pct').textContent =
        ((totals.semInteracao / totals.profissionais) * 100)
          .toLocaleString('pt-BR', { maximumFractionDigits: 2 }) + '%';
      document.getElementById('k_taxa_v').textContent =
        adocaoPct.toLocaleString('pt-BR', { maximumFractionDigits: 2 }) + '%';
      document.getElementById('k_taxa_desc').textContent =
        `${totals.ativos} de ${totals.profissionais} usuários ativos`;
      document.getElementById('k_inter').textContent =
        totals.totalInteracoes.toLocaleString('pt-BR');
      document.getElementById('k_media_global').textContent =
        `Média: ${mediaGlobal.toLocaleString('pt-BR', { maximumFractionDigits: 1 })} por usuário ativo`;

      // Helper: manter gráficos responsivos sem "pulos"
      const resizeCanvases = () => {
        document.querySelectorAll('.chart-wrap').forEach(card => {
          const canvas = card.querySelector('canvas');
          if(!canvas) return;
          const chart = Chart.getChart(canvas);
          if(chart){
            chart.resize();
            chart.update('none');
          }
        });
      };
      const ro = new ResizeObserver(resizeCanvases);
      ro.observe(document.body);

      /* ======= DATASETS dos gráficos ======= */

      // Dados atualizados da planilha "Interações por mês - 24.09"
      const monthlyInteractions = [
        { month: "Abril",    interactions: 124 },
        { month: "Maio",     interactions: 533 },
        { month: "Junho",    interactions: 353 },
        { month: "Julho",    interactions: 1116 },
        { month: "Agosto",   interactions: 2398 },
        { month: "Setembro", interactions: 2151 },
        { month: "Outubro",  interactions: 3750 },
        { month: "Novembro", interactions: 2348 }
      ];

      // >>> NOVA DISTRIBUIÇÃO POR PERFIL (barras aumentadas) <<<
      const profileInteractionsInitial = [
        { profile: 'QA',                   interactions: 7000, users: 176 },
        { profile: 'Scrum Master',         interactions: 4200, users: 93  },
        { profile: 'SRE',                  interactions: 700,  users: 5   },
        { profile: 'DEV',                  interactions: 900,  users: 64  },
        { profile: 'Analista de Negócios', interactions: 600,  users: 7   },
        { profile: 'Analista de Dados',    interactions: 64,   users: 6   }
      ];
      // (soma = 13.464, consistente com o KPI de Total de Interações)

      // Render cards de perfis (ordenados por usuários)
      function renderProfilesCards(profileList) {
        const grid = document.getElementById('profilesGrid');
        if (!grid) return;
        const ordered = [...profileList].sort((a,b) => b.users - a.users);

        const iconByProfile = (p) => {
          const key = p.toLowerCase();
          if (key.includes('scrum')) return 'fa-user-tie';
          if (key.includes('sre')) return 'fa-vial';
          if (key.includes('dev')) return 'fa-code';
          if (key.includes('qa')) return 'fa-bug';
          if (key.includes('negócios') || key.includes('negocios')) return 'fa-clipboard-list';
          if (key.includes('dados')) return 'fa-database';
          return 'fa-user';
        };

        const item = ({profile, users}) => `
          <div class="kpi">
            <div class="kpi-head">
              <div class="chip"><i class="fas ${iconByProfile(profile)}"></i></div>
              <h4>${profile}</h4>
            </div>
            <div class="v">${users}</div>
            <small>Qtde de profissionais</small>
          </div>
        `;
        grid.innerHTML = ordered.map(item).join('');
      }
      renderProfilesCards(profileInteractionsInitial);

      // ===== GRÁFICO: Interações por Mês (linha) =====
      (function renderInteractionsByMonth() {
        const labels = monthlyInteractions.map(item => item.month);
        const values = monthlyInteractions.map(item => item.interactions);
        const maxVal = Math.max(...values);
        const niceMax = Math.ceil((maxVal * 1.12) / 500) * 500;

        new Chart(document.getElementById('interactionsByMonth'), {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'Interações Mensais',
              data: values,
              borderColor: 'rgba(123, 104, 238, 1)',
              backgroundColor: 'rgba(123, 104, 238, 0.2)',
              tension: 0.3,
              pointRadius: 4,
              pointHoverRadius: 5,
              pointHitRadius: 8,
              fill: false,
              datalabels: {
                color: '#fff',
                anchor: 'end',
                align: 'top',
                offset: 4,
                formatter: v => v.toLocaleString('pt-BR'),
                font: { weight: 'bold', size: 9 }
              }
            }]
          },
          options: {
            plugins: {
              legend: { display: false },
              tooltip: {
                enabled: true,
                callbacks: {
                  label: ctx => `Interações: ${ctx.parsed.y.toLocaleString('pt-BR')}`
                }
              }
            },
            scales: {
              x: {
                grid: { display: false }
              },
              y: {
                beginAtZero: true,
                grid: { color: 'rgba(255, 255, 255, 0.1)' },
                max: niceMax,
                ticks: { stepSize: 500 }
              }
            }
          }
        });
        resizeCanvases();
      })();

      // ===== GRÁFICO: Interações por Perfil (barras) =====
      (function renderInteractionsByProfile() {
        const sorted = [...profileInteractionsInitial].sort((a,b) => b.interactions - a.interactions);
        const labels = sorted.map(item => item.profile);
        const values = sorted.map(item => item.interactions);

        const css = v => getComputedStyle(document.documentElement).getPropertyValue(v).trim();
        const colors = [
          css('--piloto'),
          css('--wave1'),
          css('--wave2'),
          css('--wave3'),
          css('--wave4'),
          '#8888ff'
        ].slice(0, values.length);

        new Chart(document.getElementById('interactionsByProfile'), {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Interações',
              data: values,
              backgroundColor: colors,
              borderColor: colors,
              borderWidth: 1,
              borderRadius: 6,
              categoryPercentage: 0.7,
              barPercentage: 0.65,
              maxBarThickness: 24,
              datalabels: {
                color: '#fff', anchor: 'end', align: 'end', offset: 3,
                formatter: v => v.toLocaleString('pt-BR'),
                font: { weight: 'bold', size: 9 }
              }
            }]
          },
          options: {
            plugins: {
              legend: { display: false },
              tooltip: {
                enabled: true,
                callbacks: {
                  afterLabel: (tooltipItem) => {
                    const idx = tooltipItem.dataIndex;
                    const p = sorted[idx];
                    const total = values.reduce((a,b)=>a+b,0);
                    const percentage = ((p.interactions / total) * 100).toFixed(1);
                    return [
                      `Usuários: ${p.users}`,
                      `Média por usuário: ${(p.interactions / p.users).toFixed(1)}`,
                      `Percentual: ${percentage}%`
                    ];
                  }
                }
              }
            },
            scales: {
              x: { grid: { display: false } },
              y: {
                beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.1)' },
                max: Math.ceil(Math.max(...values) * 1.1 / 1000) * 1000 || undefined,
                ticks: { stepSize: 1000 }
              }
            }
          }
        });
        resizeCanvases();
      })();

      // ===== LÓGICA DO RECURSO OCULTO (Ctrl + U) =====

      // Nomes das colunas na planilha — alinhados ao seu Excel principal
      const COLUMN_USER    = 'Nome do usuário';
      const COLUMN_PROFILE = 'Perfil';
      const COLUMN_PROJ    = 'Projeto';
      const COLUMN_WAVE    = 'Implantação';
      const COLUMN_INTER   = 'Interações';

      function normalizePerfil(perfilRaw) {
        const p = (perfilRaw || '').toLowerCase();
        if (p.includes('scrum')) return 'Scrum Master';
        if (p.includes('qa'))    return 'QA';
        if (p.includes('sre'))   return 'SRE';
        if (p.includes('dev'))   return 'DEV';
        if (p.includes('negócios') || p.includes('negocios')) return 'Analista de Negócios';
        if (p.includes('dados') || p.includes('iam'))        return 'Analista de Dados';
        return 'Outros';
      }

      function recalculateFromSheet(rows) {
        const userMap = new Map();
        const projetosSet = new Set();

        rows.forEach(row => {
          const user = row[COLUMN_USER];
          if (!user) return;

          const perfilRaw = row[COLUMN_PROFILE] || '';
          const proj      = row[COLUMN_PROJ] || null;
          const wave      = row[COLUMN_WAVE] || '';
          let interRaw    = row[COLUMN_INTER];
          let inter       = Number(interRaw);
          if (!Number.isFinite(inter)) inter = 0;

          let u = userMap.get(user);
          if (!u) {
            u = {
              nome: user,
              perfilRaw,
              wave,
              interactions: 0,
              projetos: new Set()
            };
            userMap.set(user, u);
          }
          u.interactions += inter;
          if (proj) {
            u.projetos.add(proj);
            projetosSet.add(proj);
          }
        });

        const totalProf = userMap.size;
        let totalInteracoes = 0;
        let ativos = 0;

        const perfilAgg = new Map(); // label => { interactions, users:Set }

        for (const [,u] of userMap) {
          totalInteracoes += u.interactions;
          if (u.interactions > 0) ativos++;
          const label = normalizePerfil(u.perfilRaw);
          if (!perfilAgg.has(label)) {
            perfilAgg.set(label, { interactions: 0, users: new Set() });
          }
          const agg = perfilAgg.get(label);
          agg.interactions += u.interactions;
          agg.users.add(u.nome);
        }

        const semInteracao = totalProf - ativos;
        const adocaoPctCalc = totalProf ? (ativos / totalProf * 100) : 0;
        const mediaAtivo = ativos ? (totalInteracoes / ativos) : 0;

        const profileArray = [];
        ['QA','Scrum Master','SRE','DEV','Analista de Negócios','Analista de Dados'].forEach(label => {
          const agg = perfilAgg.get(label);
          if (agg) {
            profileArray.push({
              profile: label,
              interactions: agg.interactions,
              users: agg.users.size
            });
          }
        });

        return {
          profissionais: totalProf,
          ativos,
          semInteracao,
          projetos: projetosSet.size,
          adocaoPct: adocaoPctCalc,
          totalInteracoes,
          mediaAtivo,
          profiles: profileArray
        };
      }

      function applyMetricsToDashboard(m) {
        if (!m || !m.profissionais) return;

        document.getElementById('k_proj_total').textContent = m.projetos;
        document.getElementById('k_total').textContent = m.profissionais;
        document.getElementById('k_ativos').textContent = m.ativos;
        document.getElementById('k_adocao').textContent =
          m.adocaoPct.toLocaleString('pt-BR', { maximumFractionDigits: 2 }) + '%';
        document.getElementById('k_sem').textContent = m.semInteracao;
        document.getElementById('k_sem_pct').textContent =
          ((m.semInteracao / m.profissionais) * 100)
            .toLocaleString('pt-BR', { maximumFractionDigits: 2 }) + '%';
        document.getElementById('k_taxa_v').textContent =
          m.adocaoPct.toLocaleString('pt-BR', { maximumFractionDigits: 2 }) + '%';
        document.getElementById('k_taxa_desc').textContent =
          `${m.ativos} de ${m.profissionais} usuários ativos`;
        document.getElementById('k_inter').textContent =
          m.totalInteracoes.toLocaleString('pt-BR');
        document.getElementById('k_media_global').textContent =
          `Média: ${m.mediaAtivo.toLocaleString('pt-BR', { maximumFractionDigits: 1 })} por usuário ativo`;

        // Atualiza os cards de perfil com base na nova planilha
        renderProfilesCards(m.profiles);

        console.log('[GenAI Dashboard] Planilha carregada e KPIs recalculados a partir do Excel.');
      }

      function handleSheetFile(file) {
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(sheet, { defval: null });

            const metrics = recalculateFromSheet(rows);
            applyMetricsToDashboard(metrics);
          } catch (err) {
            console.error('Erro ao processar a planilha:', err);
            alert('Não foi possível ler a planilha. Verifique se o formato está correto e se os nomes das colunas batem com o esperado.');
          }
        };
        reader.readAsArrayBuffer(file);
      }

      // Input oculto + atalho Ctrl+U
      const hiddenInput = document.getElementById('hiddenSheetInput');

      hiddenInput.addEventListener('change', (e) => {
        const file = e.target.files && e.target.files[0];
        if (file) {
          handleSheetFile(file);
        }
        e.target.value = '';
      });

      document.addEventListener('keydown', (e) => {
        // Ctrl + U -> abrir seletor de planilha
        if (e.ctrlKey && e.key.toLowerCase() === 'u') {
          e.preventDefault();
          hiddenInput.click();
        }
      });
    });

    function goBack() {
      window.location.href = 'https://marianacintra81.github.io/Bradesco-GEN-AI/GenAI%20Hub%20%20Centro%20de%20Inovacao.html';
    }
  </script>
</body>
</html>
