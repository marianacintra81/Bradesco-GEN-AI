<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Taxa de Adoção por Projeto — GenAI Bradesco</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg-primary:#0c0e14;
      --bg-secondary:#151823;
      --bg-card:#1e2130;
      --bg-card-hover:#272936;
      --bradesco-red:#cc0000;
      --bradesco-blue:#0033A0;
      --accent-purple:#7B68EE;
      --accent-cyan:#00e5ff;
      --text-primary:#ffffff;
      --text-secondary:#a3a8c3;
      --card-shadow:0 10px 25px -5px rgba(0,0,0,.3);
      --mixed-gradient:linear-gradient(135deg,var(--bradesco-blue),var(--accent-purple),var(--bradesco-red));
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg-primary);
      color:var(--text-primary);
      line-height:1.55;
      padding:16px;
      background-image:
        radial-gradient(circle at 10% 20%,rgba(0,51,160,.15) 0, rgba(0,51,160,0) 70%),
        radial-gradient(circle at 90% 80%,rgba(204,0,0,.15) 0, rgba(204,0,0,0) 70%);
      overflow-x:hidden;
    }

    .container{width:100%;max-width:none;margin:0 auto;overflow-x:hidden}
    .header{ text-align:center; margin-bottom:20px }
    .header h1{
      font-size:28px;font-weight:800;margin-bottom:6px;
      background:var(--mixed-gradient);-webkit-background-clip:text;background-clip:text;color:transparent;
    }

    .back-button{
      position:fixed; top:20px; left:20px;
      width:50px; height:50px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(135deg, var(--bradesco-blue), var(--accent-purple));
      color:#fff; text-decoration:none; box-shadow:var(--card-shadow);
      border:0; cursor:pointer; transition:transform .2s ease, box-shadow .2s ease, opacity .2s ease;
      z-index:1000;
    }
    .back-button:hover{ transform:translateY(-3px); box-shadow:0 20px 40px rgba(0,0,0,.4); opacity:.95 }
    .back-button svg{ width:20px; height:20px; display:block }

    .card{
      width:100%;
      background:var(--bg-card);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      box-shadow:var(--card-shadow);
      padding:16px;
      transition:background .2s ease,border-color .2s ease;
      overflow:hidden;
    }
    .card:hover{ background:var(--bg-card-hover); border-color:rgba(255,255,255,.12) }

    .toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
      margin-bottom:12px
    }
    .filters-left{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      min-width:260px;
    }
    .legend-top{
      display:flex; gap:14px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
      flex:1;
    }
    .filter-label{font-size:13px;color:var(--text-secondary)}
    select{
      background:var(--bg-secondary);
      color:var(--text-primary);
      border:1px solid rgba(255,255,255,.12);
      border-radius:8px;
      padding:8px 10px;font-size:13px
    }
    .dot{width:12px;height:12px;border-radius:3px;margin-right:6px;display:inline-block}
    .legend-top span{font-size:12px;color:var(--text-secondary)}

    .export-btn{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 14px; border-radius:10px; border:1px solid rgba(255,255,255,.14);
      background:linear-gradient(135deg, var(--bradesco-blue), var(--accent-purple));
      color:#fff; font-weight:800; letter-spacing:.2px; cursor:pointer;
      box-shadow:var(--card-shadow);
      transition:transform .18s ease, box-shadow .18s ease, opacity .18s ease;
      text-decoration:none;
    }
    .export-btn:hover{ transform:translateY(-1px); box-shadow:0 20px 40px rgba(0,0,0,.4); opacity:.95 }
    .export-btn svg{ width:16px; height:16px; display:block }

    .grid-cols{
      grid-template-columns:
        minmax(220px, 1.2fr)
        minmax(180px, 1fr)
        minmax(92px, 0.55fr)
        minmax(92px, 0.55fr)
        minmax(110px, 0.65fr)
        minmax(180px, 1fr)
        minmax(260px, 1.6fr);
    }

    .rows-wrap{
      display:flex;
      flex-direction:column;
      gap:10px;
      overflow:hidden;
      width:100%;
      min-width:0;
    }

    .row{
      display:grid; align-items:center; gap:12px;
      background:var(--bg-secondary);
      border:1px solid rgba(255,255,255,.06);
      border-radius:12px; padding:12px;
      overflow:hidden;
      width:100%;
      min-width:0;
    }
    .row > *{ min-width:0; }

    .row--header{
      background:transparent;
      border:1px dashed rgba(255,255,255,.12);
      position:sticky; top:0; z-index:2; backdrop-filter: blur(2px);
      user-select:none;
    }
    .row--header div{
      font-size:12px; font-weight:800; letter-spacing:.3px;
      text-transform:uppercase; color:var(--text-secondary);
      display:flex; align-items:center; gap:6px; cursor:pointer;
      min-width:0;
    }
    .sort-caret{font-size:10px; opacity:.8}

    .name{
      font-weight:600; font-size:14px;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }

    .bar-wrap{
      position:relative; width:100%; height:12px;
      border-radius:8px; background:rgba(255,255,255,.10); overflow:hidden;
      min-width:0;
    }
    .bar{ height:100%; border-radius:8px; width:0 }
    .bar-label{
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      font-weight:800; font-size:12px; line-height:1; padding:0 6px; border-radius:6px;
      white-space:nowrap; color:#000; background:rgba(255,255,255,.90);
    }

    .k{ display:flex;flex-direction:column;align-items:center; gap:2px; min-width:0 }
    .k .v{ font-weight:700; font-size:14px; white-space:nowrap }
    .k .l{ font-size:10px; color:var(--text-secondary); white-space:nowrap }

    .profiles{
      font-size:12px; line-height:1.35; color:#fff;
      display:flex; flex-wrap:wrap; gap:6px;
      align-items:flex-start;
      min-width:0;
    }

    .tag{
      border:1px solid rgba(255,255,255,.15);
      background:rgba(255,255,255,.05);
      padding:3px 8px;
      border-radius:999px;
      font-weight:600;
      font-size:10px;
      max-width:100%;
      min-width:0;
    }

    .usecases .tag{
      border-radius:12px;
      white-space:normal;
      overflow:hidden;
      text-overflow:ellipsis;
      display:-webkit-box;
      -webkit-box-orient:vertical;
      -webkit-line-clamp:2;
      line-height:1.25;
      max-width:100%;
    }

    @media (max-width: 1100px){
      .grid-cols{
        grid-template-columns:
          minmax(200px, 1.2fr)
          minmax(160px, 1fr)
          minmax(90px, 0.6fr)
          minmax(90px, 0.6fr)
          minmax(100px, 0.7fr)
          minmax(160px, 1fr)
          minmax(220px, 1.6fr);
      }
    }

    @media (max-width: 920px){
      .toolbar{ gap:12px }
      .legend-top{ justify-content:flex-start }
      .row{ grid-template-columns: 1fr; align-items:start; }
      .row--header{ display:none }
      .bar-wrap{ height:10px }
      .k{ align-items:flex-start }
      .profiles{ gap:6px }
      .tag{ max-width:100%; }
      .usecases .tag{ -webkit-line-clamp:2; }
    }
  </style>
</head>
<body>

  <a class="back-button" href="https://marianacintra81.github.io/Bradesco-GEN-AI/Comparativo%20de%20Implantacoes.html" aria-label="Voltar">
    <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
      <path d="M15.5 19a1 1 0 0 1-.7-.29l-6-6a1 1 0 0 1 0-1.42l6-6a1 1 0 1 1 1.4 1.42L10.91 12l5.29 5.29A1 1 0 0 1 15.5 19z" fill="currentColor"/>
    </svg>
  </a>

  <div class="container">
    <div class="header">
      <h1>Taxa de Adoção por Projeto</h1>
    </div>

    <div class="card" style="margin-bottom:14px;">
      <div class="toolbar">
        <div class="filters-left" role="group" aria-label="Filtros">
          <label class="filter-label" for="sortBy">Ordenar por:</label>
          <select id="sortBy" aria-label="Ordenação">
            <option value="adoption" selected>Taxa de Adoção</option>
            <option value="interactions">Total de Interações</option>
            <option value="avg">Média de Interações</option>
            <option value="users">Número de Usuários</option>
          </select>

          <label class="filter-label" for="waveFilter" style="margin-left:8px;">Wave:</label>
          <select id="waveFilter" aria-label="Filtro por wave">
            <option value="all" selected>Todas</option>
            <option value="Piloto">Piloto</option>
            <option value="Wave 1">Wave 1</option>
            <option value="Wave 2">Wave 2</option>
            <option value="Wave 3">Wave 3</option>
            <option value="Wave 4">Wave 4</option>
          </select>
        </div>

        <div class="legend-top" aria-hidden="false">
          <div><span class="dot" style="background:#00e5ff"></span><span>100% de adoção</span></div>
          <div><span class="dot" style="background:#7B68EE"></span><span>90–99% de adoção</span></div>
          <div><span class="dot" style="background:#0033A0"></span><span>80–89% de adoção</span></div>
          <div><span class="dot" style="background:#cc0000"></span><span>&lt; 80% de adoção</span></div>

          <button id="exportExcel" class="export-btn" title="Exportar dados para Excel">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M5 20h14a1 1 0 0 0 1-1v-6h-2v5H6v-5H4v6a1 1 0 0 0 1 1zm7-3 5-5h-3V4h-4v8H7l5 5z" fill="currentColor"/>
            </svg>
            Exportar Excel
          </button>
        </div>
      </div>

      <div class="rows-wrap">
        <div class="row row--header grid-cols" role="row">
          <div data-col="name"               aria-sort="none">Projeto <span class="sort-caret">↕</span></div>
          <div data-col="adoptionRate"       aria-sort="descending">Taxa de Adoção <span class="sort-caret">↓</span></div>
          <div data-col="totalInteractions"  aria-sort="none">Interações <span class="sort-caret">↕</span></div>
          <div data-col="avg"                aria-sort="none">Média <span class="sort-caret">↕</span></div>
          <div data-col="totalUsers"         aria-sort="none">Usuários <span class="sort-caret">↕</span></div>
          <div>Perfis Treinados</div>
          <div>Casos de Uso</div>
        </div>

        <div id="rows"></div>
      </div>
    </div>
  </div>

  <input type="file" id="hiddenSheetInput" accept=".xlsx,.xls,.csv" style="display:none" />

  <script>
    const baseProjects = [
      { name:'Plataforma de segurança Safer', totalUsers:39, activeUsers:38, adoptionRate:97.4, totalInteractions:1902, wave:'Piloto', profiles:['DEV','QA','Scrum Master','SRE'], useCases:[] },
      { name:'Open Finance', totalUsers:5, activeUsers:5, adoptionRate:100.0, totalInteractions:756, wave:'Piloto', profiles:['QA'], useCases:[] },
      { name:'Reabilitação Financeira', totalUsers:46, activeUsers:37, adoptionRate:80.4, totalInteractions:1087, wave:'Wave 2', profiles:['QA','DEV','Scrum Master','Analista de Negócios'], useCases:[] },
      { name:'Plataforma A3C', totalUsers:21, activeUsers:19, adoptionRate:90.5, totalInteractions:881, wave:'Wave 1', profiles:['QA','Scrum Master','DEV'], useCases:[] },
      { name:'BRAIN', totalUsers:28, activeUsers:27, totalInteractions:1614, adoptionRate:96.4, wave:'Wave 2', profiles:['QA'], useCases:[] },
      { name:'Contadoria', totalUsers:17, activeUsers:14, adoptionRate:82.4, totalInteractions:822, wave:'Wave 3', profiles:['Analista de Negócios','QA','Scrum Master','DEV','Analista de Dados'], useCases:[] },
      { name:'CRM', totalUsers:9, activeUsers:9, adoptionRate:100.0, totalInteractions:413, wave:'Wave 2', profiles:['QA'], useCases:[] },
      { name:'Consignado', totalUsers:12, activeUsers:11, adoptionRate:91.7, totalInteractions:442, wave:'Wave 3', profiles:['Scrum Master'], useCases:[] },
      { name:'Massificado', totalUsers:9, activeUsers:9, adoptionRate:100.0, totalInteractions:325, wave:'Wave 2', profiles:['QA','Scrum Master'], useCases:[] },
      { name:'ATACADO', totalUsers:2, activeUsers:2, adoptionRate:100.0, totalInteractions:298, wave:'Wave 3', profiles:['QA'], useCases:[] },
      { name:'Sala Core', totalUsers:8, activeUsers:8, adoptionRate:100.0, totalInteractions:274, wave:'Wave 2', profiles:['QA','Scrum Master'], useCases:[] },
      { name:'Abertura de Contas', totalUsers:8, activeUsers:8, adoptionRate:100.0, totalInteractions:233, wave:'Wave 3', profiles:['QA','Scrum Master'], useCases:[] },
      { name:'Soluçoes PJ', totalUsers:9, activeUsers:9, adoptionRate:100.0, totalInteractions:318, wave:'Wave 3', profiles:['Scrum Master'], useCases:[] },
      { name:'Transformação', totalUsers:8, activeUsers:8, adoptionRate:100.0, totalInteractions:244, wave:'Piloto', profiles:['Analista de Negócios','QA','DEV','Scrum Master'], useCases:[] },
      { name:'Investimentos', totalUsers:1, activeUsers:1, adoptionRate:100.0, totalInteractions:167, wave:'Piloto', profiles:['QA'], useCases:[] },
      { name:'Bradesco Global Solutions', totalUsers:8, activeUsers:7, adoptionRate:87.5, totalInteractions:195, wave:'Wave 1', profiles:['QA','DEV','Scrum Master'], useCases:[] },
      { name:'Pessoa Fisica', totalUsers:12, activeUsers:10, adoptionRate:83.3, totalInteractions:179, wave:'Wave 4', profiles:['DEV','Scrum Master'], useCases:[] },
      { name:'CONSIGNADO - E-Social', totalUsers:10, activeUsers:9, adoptionRate:90.0, totalInteractions:169, wave:'Wave 3', profiles:['QA'], useCases:[] },
      { name:'Cluster Soluções de Pagamento e Conciliação', totalUsers:1, activeUsers:1, adoptionRate:100.0, totalInteractions:118, wave:'Wave 3', profiles:['Scrum Master'], useCases:[] },
      { name:'CONSIGNADO - Pleito de Priorização INSS', totalUsers:1, activeUsers:1, adoptionRate:100.0, totalInteractions:39, wave:'Wave 3', profiles:['QA'], useCases:[] },
      { name:'BSPI', totalUsers:8, activeUsers:8, adoptionRate:100.0, totalInteractions:149, wave:'Wave 3', profiles:['DEV','Scrum Master','QA'], useCases:[] },
      { name:'PIX-CPF', totalUsers:1, activeUsers:1, adoptionRate:100.0, totalInteractions:93, wave:'Wave 2', profiles:['QA'], useCases:[] },
      { name:'SCAP', totalUsers:3, activeUsers:3, adoptionRate:100.0, totalInteractions:72, wave:'Wave 2', profiles:['QA'], useCases:[] },
      { name:'INTERNACIONAL E CÂMBIO', totalUsers:6, activeUsers:6, adoptionRate:100.0, totalInteractions:79, wave:'Wave 3', profiles:['QA','Scrum Master'], useCases:[] },
      { name:'Plataforma Atendimento', totalUsers:6, activeUsers:4, adoptionRate:66.7, totalInteractions:29, wave:'Wave 1', profiles:['QA'], useCases:[] },
      { name:'PROJETO PT-W50594', totalUsers:1, activeUsers:1, adoptionRate:100.0, totalInteractions:54, wave:'Wave 3', profiles:['Scrum Master'], useCases:[] },
      { name:'PIX-CPJ', totalUsers:4, activeUsers:4, adoptionRate:100.0, totalInteractions:55, wave:'Wave 2', profiles:['QA'], useCases:[] },
      { name:'CONSÓRCIO | Consorcio', totalUsers:4, activeUsers:4, adoptionRate:100.0, totalInteractions:41, wave:'Wave 3', profiles:['QA'], useCases:[] },
      { name:'Site Gestor', totalUsers:1, activeUsers:1, adoptionRate:100.0, totalInteractions:26, wave:'Wave 3', profiles:['Scrum Master'], useCases:[] },
      { name:'Consignado - Portabilidade', totalUsers:3, activeUsers:2, adoptionRate:66.7, totalInteractions:69, wave:'Wave 4', profiles:['DEV','Scrum Master'], useCases:[] },
      { name:'MBPF', totalUsers:4, activeUsers:3, adoptionRate:75.0, totalInteractions:37, wave:'Wave 3', profiles:['DEV','Scrum Master','QA'], useCases:[] },
      { name:'PDPJ', totalUsers:2, activeUsers:2, adoptionRate:100.0, totalInteractions:38, wave:'Wave 3', profiles:['DEV','Scrum Master'], useCases:[] },
      { name:'Internet Banking', totalUsers:2, activeUsers:2, adoptionRate:100.0, totalInteractions:35, wave:'Piloto', profiles:['QA'], useCases:[] },
      { name:'CONSIGNADO - Mktplace Consignado', totalUsers:3, activeUsers:3, adoptionRate:100.0, totalInteractions:24, wave:'Wave 3', profiles:['QA'], useCases:[] },
      { name:'Tesouraria', totalUsers:3, activeUsers:3, adoptionRate:100.0, totalInteractions:53, wave:'Wave 2', profiles:['QA','Scrum Master'], useCases:[] },
      { name:'VATINTR', totalUsers:1, activeUsers:1, adoptionRate:100.0, totalInteractions:17, wave:'Wave 3', profiles:['QA'], useCases:[] },
      { name:'PEPF', totalUsers:2, activeUsers:1, adoptionRate:50.0, totalInteractions:12, wave:'Wave 4', profiles:['QA'], useCases:[] },
      { name:'MBPJ', totalUsers:2, activeUsers:1, adoptionRate:50.0, totalInteractions:5, wave:'Wave 4', profiles:['DEV','Scrum Master'], useCases:[] },
      { name:'Tribo Canais Assistidos', totalUsers:1, activeUsers:1, adoptionRate:100.0, totalInteractions:4, wave:'Wave 3', profiles:['Scrum Master'], useCases:[] },
      { name:'AFLUENTES', totalUsers:3, activeUsers:1, adoptionRate:33.3, totalInteractions:16, wave:'Wave 3', profiles:['QA'], useCases:[] },
      { name:'Agora Trader', totalUsers:2, activeUsers:1, adoptionRate:50.0, totalInteractions:1, wave:'Wave 4', profiles:['QA'], useCases:[] },
      { name:'CNPJ Alfanumérico', totalUsers:1, activeUsers:1, adoptionRate:100.0, totalInteractions:1, wave:'Wave 4', profiles:['Analista de Dados'], useCases:[] },
      { name:'Tribo Contas e Tarifas', totalUsers:1, activeUsers:1, adoptionRate:100.0, totalInteractions:80, wave:'Wave 3', profiles:['Scrum Master'], useCases:[] },
    ];

    let projectsData = baseProjects.map(p => ({...p, profiles:[...(p.profiles||[])], useCases:[...(p.useCases||[])] }));

    function normalizeLabel(str){
      return String(str ?? '')
        .replace(/[\u200B-\u200D\uFEFF]/g,'')      // remove espaços invisíveis
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g,'')
        .toLowerCase()
        .trim();
    }
    function normalizeKey(str){ return normalizeLabel(str).replace(/\s+/g,''); }

    // Split de célula com múltiplos casos: vírgula, ;, |, quebra de linha
    function explodeUseCaseTokens(value){
      if (value == null) return [];
      // Se vier número, boolean etc: ignora
      const s = String(value).replace(/[\u200B-\u200D\uFEFF]/g,'').trim();
      if (!s) return [];
      // separadores comuns em planilha: vírgula, ponto e vírgula, pipe, newline, tab
      return s
        .split(/[,;|\n\r\t]+/g)
        .map(x => x.trim().replace(/\s+/g,' '))
        .filter(Boolean);
    }

    function dedupeLabelsByNorm(list){
      const m = new Map(); // norm -> raw
      (Array.isArray(list) ? list : []).forEach(v => {
        if (typeof v !== 'string') return;
        const raw = v.trim().replace(/\s+/g,' ');
        if (!raw) return;
        const norm = normalizeLabel(raw);
        if (!norm) return;

        if (!m.has(norm)) m.set(norm, raw);
        else {
          const prev = m.get(norm);
          if ((raw.length || 0) > (String(prev).length || 0)) m.set(norm, raw);
        }
      });
      return Array.from(m.values());
    }

    const STORAGE_KEY = 'genai_taxa_adocao_por_projeto__projectsData_v4';

    function persistProjectsData(){
      try{
        const payload = projectsData.map(p => ({
          ...p,
          profiles: Array.isArray(p.profiles) ? p.profiles : [],
          useCases: dedupeLabelsByNorm(p.useCases)
        }));
        localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      }catch(e){
        console.warn('[Persistência] Falha ao salvar:', e);
      }
    }

    function restoreProjectsData(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return false;

        projectsData = parsed.map(p => ({
          ...p,
          profiles: Array.isArray(p.profiles) ? p.profiles : [],
          useCases: dedupeLabelsByNorm(p.useCases)
        }));

        persistProjectsData();
        return true;
      }catch(e){
        console.warn('[Persistência] Falha ao restaurar:', e);
        return false;
      }
    }
    restoreProjectsData();

    function colorByAdoption(rate){
      if (rate === 100) return '#00e5ff';
      if (rate >= 90) return '#7B68EE';
      if (rate >= 80) return '#0033A0';
      return '#cc0000';
    }
    function getProfilesText(p){
      return (Array.isArray(p.profiles) && p.profiles.length) ? p.profiles.join(', ') : '-';
    }
    function getUseCasesText(p){
      const unique = dedupeLabelsByNorm(p.useCases);
      return unique.length ? unique.join(', ') : '-';
    }
    const avgOf = p => (p.totalUsers ? (p.totalInteractions / p.totalUsers) : 0);

    const rowsMountPoint = document.getElementById('rows');
    const sortBy = document.getElementById('sortBy');
    const waveFilter = document.getElementById('waveFilter');

    let headerSort = { col: 'adoptionRate', dir: 'desc' };

    function applySort(data){
      const key = headerSort.col || 'adoptionRate';
      const dir = (headerSort.dir === 'asc') ? 1 : -1;

      const cmp = {
        name: (a,b)=> a.name.localeCompare(b.name) * dir,
        adoptionRate: (a,b)=> ((Number(a.adoptionRate)||0) - (Number(b.adoptionRate)||0)) * dir || a.name.localeCompare(b.name)*dir,
        totalInteractions: (a,b)=> ((Number(a.totalInteractions)||0) - (Number(b.totalInteractions)||0)) * dir || a.name.localeCompare(b.name)*dir,
        avg: (a,b)=> (avgOf(a) - avgOf(b)) * dir || a.name.localeCompare(b.name)*dir,
        totalUsers: (a,b)=> ((Number(a.totalUsers)||0) - (Number(b.totalUsers)||0)) * dir || a.name.localeCompare(b.name)*dir,
      }[key];

      return data.sort(cmp);
    }

    function render(){
      rowsMountPoint.innerHTML = '';
      const wave = waveFilter.value;

      let data = projectsData.slice();
      if (wave !== 'all') data = data.filter(p => p.wave === wave);

      if (sortBy.dataset.userChanged === 'true') {
        headerSort.col =
          sortBy.value === 'adoption'     ? 'adoptionRate' :
          sortBy.value === 'interactions' ? 'totalInteractions' :
          sortBy.value === 'avg'          ? 'avg' :
          'totalUsers';
        headerSort.dir = 'desc';
      }

      data = applySort(data);

      data.forEach(p=>{
        const row = document.createElement('div');
        row.className = 'row grid-cols';

        const name = document.createElement('div');
        name.className = 'name';
        name.title = p.name;
        name.textContent = p.name;

        const barWrap = document.createElement('div');
        barWrap.className = 'bar-wrap';
        const bar = document.createElement('div');
        bar.className = 'bar';
        const rate = Math.max(0, Math.min(100, Number(p.adoptionRate) || 0));
        bar.style.backgroundColor = colorByAdoption(rate);
        bar.style.width = rate + '%';
        const label = document.createElement('span');
        label.className = 'bar-label';
        label.textContent = (Number.isInteger(rate) ? rate.toFixed(0) : rate.toFixed(1)) + '%';
        barWrap.appendChild(bar);
        barWrap.appendChild(label);

        const kInter = document.createElement('div');
        kInter.className = 'k';
        kInter.innerHTML = `<div class="v">${(p.totalInteractions||0).toLocaleString('pt-BR')}</div><div class="l">Interações</div>`;

        const kAvg = document.createElement('div');
        kAvg.className = 'k';
        const avg = avgOf(p);
        kAvg.innerHTML = `<div class="v">${avg.toFixed(1)}</div><div class="l">Média</div>`;

        const kUsers = document.createElement('div');
        kUsers.className = 'k';
        kUsers.innerHTML = `<div class="v">${p.activeUsers}/${p.totalUsers}</div><div class="l">Usuários</div>`;

        const profilesBox = document.createElement('div');
        profilesBox.className = 'profiles';
        const list = getProfilesText(p).split(',').map(s => s.trim()).filter(Boolean);
        if (list.length === 0) {
          const t = document.createElement('span'); t.className = 'tag'; t.textContent = '-';
          profilesBox.appendChild(t);
        } else {
          list.forEach(labelTxt=>{
            const t = document.createElement('span'); t.className = 'tag'; t.textContent = labelTxt;
            profilesBox.appendChild(t);
          });
        }

        const useCasesBox = document.createElement('div');
        useCasesBox.className = 'profiles usecases';
        const useCasesList = dedupeLabelsByNorm(p.useCases);

        if (useCasesList.length === 0) {
          const t = document.createElement('span'); t.className = 'tag'; t.textContent = '-';
          useCasesBox.appendChild(t);
        } else {
          useCasesList.forEach(useCase=>{
            const t = document.createElement('span'); t.className = 'tag'; t.textContent = useCase;
            useCasesBox.appendChild(t);
          });
        }

        row.appendChild(name);
        row.appendChild(barWrap);
        row.appendChild(kInter);
        row.appendChild(kAvg);
        row.appendChild(kUsers);
        row.appendChild(profilesBox);
        row.appendChild(useCasesBox);

        rowsMountPoint.appendChild(row);
      });

      sortBy.dataset.userChanged = 'false';
    }

    sortBy.addEventListener('change', () => {
      sortBy.dataset.userChanged = 'true';
      render();
    });
    waveFilter.addEventListener('change', render);

    document.querySelectorAll('.row--header div[data-col]').forEach(el=>{
      el.addEventListener('click', ()=>{
        const col = el.getAttribute('data-col');
        headerSort.dir = (headerSort.col === col && headerSort.dir === 'desc') ? 'asc' : 'desc';
        headerSort.col = col;

        document.querySelectorAll('.row--header div[data-col]').forEach(h=>{
          const caret = h.querySelector(' .sort-caret');
          if (!caret) return;
          if (h.getAttribute('data-col') === col){
            caret.textContent = (headerSort.dir === 'asc' ? '↑' : '↓');
            h.setAttribute('aria-sort', headerSort.dir === 'asc' ? 'ascending' : 'descending');
          } else {
            caret.textContent = '↕';
            h.setAttribute('aria-sort', 'none');
          }
        });

        sortBy.dataset.userChanged = 'false';
        render();
      });
    });

    function getCurrentDataView(){
      const wave = waveFilter.value;
      let data = projectsData.slice();
      if (wave !== 'all') data = data.filter(p => p.wave === wave);
      data = applySort(data);

      return data.map(p => {
        const avg = avgOf(p);
        return {
          'Projeto': p.name,
          'Wave': p.wave,
          'Usuários Totais': p.totalUsers,
          'Usuários Ativos': p.activeUsers,
          'Taxa de Adoção (%)': Number((Number(p.adoptionRate ?? 0)).toFixed(1)),
          'Interações': p.totalInteractions,
          'Média por Usuário': Number(avg.toFixed(1)),
          'Perfis Treinados': getProfilesText(p),
          'Casos de Uso': getUseCasesText(p)
        };
      });
    }

    function getSummary(rows){
      const totalProjetos = rows.length;
      const totalUsers = rows.reduce((acc,r)=> acc + (r['Usuários Totais']||0), 0);
      const activeUsers = rows.reduce((acc,r)=> acc + (r['Usuários Ativos']||0), 0);
      const totalInter = rows.reduce((acc,r)=> acc + (r['Interações']||0), 0);
      const adocaoGeral = totalUsers ? (activeUsers/totalUsers*100) : 0;
      const mediaGeral = totalUsers ? (totalInter/totalUsers) : 0;

      return [
        ['Métrica','Valor'],
        ['Projetos (exibidos)', totalProjetos],
        ['Usuários Totais', totalUsers],
        ['Usuários Ativos', activeUsers],
        ['Taxa de Adoção Geral (%)', Number(adocaoGeral.toFixed(2))],
        ['Interações Totais', totalInter],
        ['Média de Interações por Usuário', Number(mediaGeral.toFixed(1))]
      ];
    }

    function exportToExcel(){
      const rows = getCurrentDataView();
      const wb = XLSX.utils.book_new();

      const wsProjects = XLSX.utils.json_to_sheet(rows, {header: [
        'Projeto','Wave','Usuários Totais','Usuários Ativos','Taxa de Adoção (%)','Interações','Média por Usuário','Perfis Treinados','Casos de Uso'
      ]});
      XLSX.utils.book_append_sheet(wb, wsProjects, 'Projetos');

      const resumo = getSummary(rows);
      const wsResumo = XLSX.utils.aoa_to_sheet(resumo);
      XLSX.utils.book_append_sheet(wb, wsResumo, 'Resumo');

      const now = new Date();
      const pad = n => String(n).padStart(2,'0');
      const fileName = `Taxa_Adocao_Projetos_${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}.xlsx`;

      XLSX.writeFile(wb, fileName);
    }
    document.getElementById('exportExcel').addEventListener('click', exportToExcel);

    /* =======================
       IMPORTAÇÃO
       - Split dos casos de uso na célula
       - Substitui (limpa) a lista anterior por projeto
       - Match de projeto: EXATO (normalizado)
       ======================= */

    function findKey(allKeys, candidates){
      const candNorm = candidates.map(c => normalizeKey(c));
      for (const k of allKeys){
        const nk = normalizeKey(k);
        if (candNorm.includes(nk)) return k;
      }
      for (const k of allKeys){
        const nk = normalizeKey(k);
        for (const c of candNorm){
          if (nk.includes(c) || c.includes(nk)) return k;
        }
      }
      return null;
    }

    function detectSchema(rows){
      const keysSet = new Set();
      rows.slice(0, 80).forEach(r => {
        if (!r) return;
        Object.keys(r).forEach(k => keysSet.add(k));
      });
      const keys = Array.from(keysSet);

      const projKey = findKey(keys, ['Projeto','Nome do Projeto','Nome Projeto','Project']);
      const cuKey   = findKey(keys, ['Caso de Uso','Casos de Uso','Use Case','UseCase','Case de Uso','CasodeUso','CasoUso']);
      const cu2Key  = findKey(keys, ['CasoDeUsoNome','Caso de Uso Nome','Nome do Caso de Uso','Use Case Name','UseCaseName']);
      const cu3Key  = findKey(keys, ['Caso de Uso Treinado','Casos de Uso Treinados','Use Case Trained','UseCaseTrained','Treinado','Treinados']);

      return { projKey, cuKey, cu2Key, cu3Key };
    }

    function aggregateUseCasesFromSheet(rows, schema){
      const projMap = new Map(); // projNorm -> Map(useNorm -> raw)
      const { projKey, cuKey, cu2Key, cu3Key } = schema;

      rows.forEach(row => {
        const projName = projKey ? row[projKey] : null;
        if (!projName) return;

        const rawProj = String(projName).trim().replace(/\s+/g, ' ');
        if (!rawProj) return;

        const projNorm = normalizeLabel(rawProj);

        let labelsMap = projMap.get(projNorm);
        if (!labelsMap) {
          labelsMap = new Map();
          projMap.set(projNorm, labelsMap);
        }

        const fields = [
          cuKey  ? row[cuKey]  : null,
          cu2Key ? row[cu2Key] : null,
          cu3Key ? row[cu3Key] : null,
        ];

        fields.forEach(val => {
          // Aqui é o ponto-chave: explode "Cenários de teste, Ponto de função" em 2 tokens.
          const tokens = explodeUseCaseTokens(val);
          tokens.forEach(raw => {
            const norm = normalizeLabel(raw);
            if (!norm) return;

            if (!labelsMap.has(norm)) labelsMap.set(norm, raw);
            else {
              const prev = labelsMap.get(norm);
              if ((raw.length || 0) > (String(prev).length || 0)) labelsMap.set(norm, raw);
            }
          });
        });
      });

      return projMap;
    }

    function applyUseCasesToProjects(useCasesByProject){
      // Substitui sempre: se não vier nada na planilha, fica []
      projectsData = projectsData.map(p => {
        const projNorm = normalizeLabel(String(p.name || '').trim().replace(/\s+/g,' '));
        const labelsMap = useCasesByProject.get(projNorm);
        const fromSheet = labelsMap ? Array.from(labelsMap.values()) : [];
        return { ...p, useCases: dedupeLabelsByNorm(fromSheet) };
      });

      persistProjectsData();
      render();
      console.log('[Taxa Adoção Projetos] Import OK: substituição + split + dedupe.');
    }

    function handleSheetFile(file){
      if (!file) return;
      const reader = new FileReader();

      reader.onload = function(e){
        try{
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, { type:'array' });

          const sheetName = wb.SheetNames[0];
          const sheet = wb.Sheets[sheetName];
          const rows = XLSX.utils.sheet_to_json(sheet, { defval: null });

          const schema = detectSchema(rows);
          if (!schema.projKey){
            alert('Não encontrei a coluna de Projeto na planilha (ex.: "Projeto"). Verifique o cabeçalho.');
            return;
          }
          if (!schema.cuKey && !schema.cu2Key && !schema.cu3Key){
            alert('Não encontrei colunas de Caso de Uso (ex.: "Caso de Uso" / "CasoDeUsoNome" / "Caso de Uso Treinado"). Verifique o cabeçalho.');
            return;
          }

          const useCasesByProject = aggregateUseCasesFromSheet(rows, schema);
          if (!useCasesByProject.size) {
            alert('Não foram encontrados casos de uso preenchidos na planilha.');
            return;
          }

          applyUseCasesToProjects(useCasesByProject);
        } catch(err){
          console.error('Erro ao processar planilha:', err);
          alert('Não foi possível ler a planilha. Verifique se existe coluna de Projeto e Caso(s) de Uso.');
        }
      };

      reader.readAsArrayBuffer(file);
    }

    const hiddenInput = document.getElementById('hiddenSheetInput');
    hiddenInput.addEventListener('change', (e)=>{
      const file = e.target.files && e.target.files[0];
      if (file) handleSheetFile(file);
      e.target.value = '';
    });

    // Ctrl+U para anexar planilha (quantas vezes precisar)
    document.addEventListener('keydown', (e)=>{
      if (e.ctrlKey && !e.shiftKey && !e.altKey && !e.metaKey && e.key.toLowerCase() === 'u') {
        e.preventDefault();
        e.stopPropagation();
        if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
        hiddenInput.click();
      }
    }, true);

    render();
  </script>
</body>
</html>
